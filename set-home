#!/bin/bash
set -euo pipefail

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
HOME_BACK_UP_DIR="$HOME/.bu/home-files/"
BIN_BACK_UP_DIR="$HOME/.bu/bin-files/"

echo "Setting up dotfiles from: $SCRIPT_DIR"

# Create backup directories
echo "Creating backup directories..."
mkdir -p "$HOME_BACK_UP_DIR"
mkdir -p "$BIN_BACK_UP_DIR"
mkdir -p "$HOME/.local/bin"

# Function to backup and link files
backup_and_link() {
    local source_dir="$1"
    local target_dir="$2"
    local backup_dir="$3"
    local description="$4"

    echo "Processing $description files..."

    # Find all files (not directories) in source directory
    while IFS= read -r -d '' file; do
        filename="$(basename "$file")"
        target_file="$target_dir/$filename"

        # Backup existing file if it exists and is not already a symlink to our file
        if [[ -e "$target_file" && ! -L "$target_file" ]]; then
            echo "  Backing up existing '$filename'..."
            mv "$target_file" "$backup_dir"
        elif [[ -L "$target_file" ]]; then
            # Remove existing symlink
            echo "  Removing existing symlink '$filename'..."
            rm "$target_file"
        fi

        # Create new symlink
        echo "  Linking '$filename'..."
        ln -s "$file" "$target_file"

    done < <(find "$source_dir" -maxdepth 1 -type f -print0)
}

# Check if required directories exist
if [[ ! -d "$SCRIPT_DIR/home-dir" ]]; then
    echo "Error: home-dir directory not found in $SCRIPT_DIR"
    exit 1
fi

if [[ ! -d "$SCRIPT_DIR/bin-dir" ]]; then
    echo "Error: bin-dir directory not found in $SCRIPT_DIR"
    exit 1
fi

# Backup and link home files
backup_and_link "$SCRIPT_DIR/home-dir" "$HOME" "$HOME_BACK_UP_DIR" "home"

# Backup and link bin files
backup_and_link "$SCRIPT_DIR/bin-dir" "$HOME/.local/bin" "$BIN_BACK_UP_DIR" "bin"

echo "Dotfiles setup completed successfully!"
echo "Backups are stored in:"
echo "  Home files: $HOME_BACK_UP_DIR"
echo "  Bin files: $BIN_BACK_UP_DIR"

